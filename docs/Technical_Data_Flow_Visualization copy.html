<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Agent Data Flow | Technical Deep Dive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap');

        :root {
            --bg-dark: #0B1120;
            --panel-bg: #1e293b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            overflow: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* --- NODE STYLING --- */
        .node {
            position: absolute;
            width: 140px;
            padding: 0.75rem;
            border-radius: 1rem;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(8px);
            text-align: center;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            opacity: 0.4;
            transform: scale(0.95);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .node.active {
            opacity: 1;
            transform: scale(1.1);
            border-color: var(--accent-blue);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
            background: #1e293b;
            z-index: 30;
        }

        .node.secure-active {
            border-color: var(--accent-green);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
        }

        .node.ai-active {
            border-color: var(--accent-purple);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }

        .node.fs-active {
            border-color: var(--accent-orange);
            box-shadow: 0 0 30px rgba(249, 115, 22, 0.3);
        }

        /* --- CONNECTORS & ANIMATIONS --- */
        svg {
            pointer-events: none;
            z-index: 10;
        }

        .connector-path {
            fill: none;
            stroke: #334155;
            stroke-width: 2;
            stroke-dasharray: 6;
            opacity: 0.3;
            transition: stroke 0.5s ease, opacity 0.5s ease;
        }

        .connector-path.active {
            stroke: var(--accent-blue);
            opacity: 1;
            stroke-dasharray: 0;
            /* Solid Line */
            filter: drop-shadow(0 0 4px var(--accent-blue));
        }

        .connector-path.secure {
            stroke: var(--accent-green);
            filter: drop-shadow(0 0 4px var(--accent-green));
        }

        .connector-path.exec {
            stroke: var(--accent-purple);
            filter: drop-shadow(0 0 4px var(--accent-purple));
        }

        /* Data Packet Animation */
        .packet {
            fill: white;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .packet.animating {
            opacity: 1;
            animation: travel 1.5s linear infinite;
        }

        @keyframes travel {
            0% {
                offset-distance: 0%;
                opacity: 0;
                transform: scale(0.5);
            }

            10% {
                opacity: 1;
                transform: scale(1.2);
            }

            90% {
                opacity: 1;
                transform: scale(1.2);
            }

            100% {
                offset-distance: 100%;
                opacity: 0;
                transform: scale(0.5);
            }
        }

        /* --- DETAIL CARDS --- */
        .detail-card {
            background: #1e293b;
            border-left: 4px solid var(--accent-blue);
            transition: all 0.3s ease;
        }

        .detail-card.secure {
            border-left-color: var(--accent-green);
        }

        .detail-card.ai {
            border-left-color: var(--accent-purple);
        }

        .detail-card.fs {
            border-left-color: var(--accent-orange);
        }

        /* Syntax Highlighting */
        .code-block {
            background: #0f172a;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #334155;
        }

        .k {
            color: #f472b6;
        }

        /* Keyword */
        .s {
            color: #a5f3fc;
        }

        /* String */
        .f {
            color: #8b5cf6;
        }

        /* Function */
        .c {
            color: #64748b;
            font-style: italic;
        }

        /* Comment */
        .n {
            color: #fbbf24;
        }

        /* Number/Constant */

        /* Badge pulse */
        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .secure-dot {
            animation: pulse-green 2s infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="flex flex-col h-screen">

    <!-- TOP BAR -->
    <nav class="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 z-50 shadow-lg">
        <div class="flex items-center gap-4">
            <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-900/50">
                <i class="fas fa-network-wired text-white text-sm"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold text-white uppercase tracking-wider">AI Agent Architecture <span
                        class="text-slate-500">|</span> Deep Dive</h1>
                <div class="flex gap-4 text-[10px] text-slate-400 mt-0.5">
                    <span class="flex items-center gap-1.5"><span
                            class="w-1.5 h-1.5 rounded-full bg-green-500"></span>Secure Zone</span>
                    <span class="flex items-center gap-1.5"><span
                            class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>Cloud AI Zone</span>
                    <span class="flex items-center gap-1.5"><span
                            class="w-1.5 h-1.5 rounded-full bg-orange-500"></span>Persistence</span>
                </div>
            </div>
        </div>

        <div class="flex bg-slate-950 p-1 rounded-lg border border-slate-700">
            <button onclick="setFlow('generation')" id="tab-gen"
                class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-md flex items-center gap-2">
                <i class="fas fa-magic"></i> GENERATION FLOW
            </button>
            <button onclick="setFlow('execution')" id="tab-exec"
                class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition-all flex items-center gap-2">
                <i class="fas fa-play"></i> EXECUTION FLOW
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">

        <!-- LEFT: DIAGRAM CANVAS -->
        <div class="w-8/12 relative bg-[#0B1120] overflow-hidden group cursor-grab active:cursor-grabbing" id="canvas">
            <!-- Dynamic Grid -->
            <div class="absolute inset-0 opacity-20"
                style="background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 32px 32px;">
            </div>

            <!-- Diagram Container -->
            <div class="relative w-full h-full flex items-center justify-center transform scale-95">
                <div class="relative w-[800px] h-[600px]">

                    <!-- SVG Connectors -->
                    <svg class="absolute inset-0 w-full h-full overflow-visible">
                        <defs>
                            <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" />
                            </marker>
                            <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <path d="M0,0 L0,6 L9,3 z" fill="#10b981" />
                            </marker>
                            <marker id="arrow-purple" markerWidth="10" markerHeight="10" refX="9" refY="3"
                                orient="auto">
                                <path d="M0,0 L0,6 L9,3 z" fill="#8b5cf6" />
                            </marker>
                            <marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="9" refY="3"
                                orient="auto">
                                <path d="M0,0 L0,6 L9,3 z" fill="#f97316" />
                            </marker>
                        </defs>

                        <!-- SHARED PATHS -->
                        <path id="p-1" class="connector-path" d="M400,50 L400,120" /> <!-- UI -> Server -->

                        <!-- GENERATION PATHS -->
                        <path id="p-2" class="connector-path" d="M330,160 C200,160 200,200 160,250" />
                        <!-- Server -> Secrets -->

                        <!-- CORRECTED PATH: Secrets -> FS (Cache Check) - Upward Curve -->
                        <path id="p-3a" class="connector-path" d="M160,250 C160,200 330,200 330,300" />

                        <path id="p-3b" class="connector-path" d="M160,330 C160,380 250,380 330,450" />
                        <!-- Secrets -> Browser (Inject) -->
                        <path id="p-4" class="connector-path" d="M470,160 C600,160 600,200 640,250" />
                        <!-- Server -> Agent -->
                        <path id="p-5" class="connector-path" d="M640,330 L640,450" /> <!-- Agent -> LLM -->
                        <path id="p-6" class="connector-path" d="M640,450 L640,330" /> <!-- LLM -> Agent -->
                        <path id="p-7" class="connector-path" d="M600,300 C500,300 500,450 450,450" />
                        <!-- Agent -> Browser (Control) -->
                        <path id="p-8" class="connector-path" d="M640,250 C600,100 500,100 470,130" />
                        <!-- Agent -> Server (Return) -->
                        <path id="p-9" class="connector-path" d="M400,200 L400,300" />
                        <!-- Server -> FS (Save Script) -->

                        <!-- EXECUTION PATHS -->
                        <path id="p-10" class="connector-path" d="M330,160 C250,160 250,250 280,300" />
                        <!-- Server -> Subprocess -->
                        <path id="p-11" class="connector-path" d="M280,380 C280,420 350,420 350,450" />
                        <!-- Subprocess -> Browser -->

                        <!-- Animated Packet -->
                        <circle r="4" class="packet" id="packet">
                            <animateMotion dur="1.5s" repeatCount="indefinite" id="packet-anim">
                                <mpath href="#p-1" />
                            </animateMotion>
                        </circle>
                    </svg>

                    <!-- NODES -->
                    <!-- 1. User -->
                    <div id="node-1" class="node" style="top: 0px; left: 330px;">
                        <div
                            class="w-10 h-10 bg-slate-800 rounded-full mx-auto mb-2 flex items-center justify-center border border-slate-600 shadow-inner">
                            <i class="fas fa-desktop text-blue-400"></i>
                        </div>
                        <div class="font-bold text-white text-xs">User UI</div>
                    </div>

                    <!-- 2. Server -->
                    <div id="node-2" class="node" style="top: 120px; left: 330px;">
                        <div
                            class="w-10 h-10 bg-indigo-900/50 rounded-full mx-auto mb-2 flex items-center justify-center border border-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                            <i class="fas fa-server text-indigo-400"></i>
                        </div>
                        <div class="font-bold text-white text-xs">Python Server</div>
                        <div class="text-[9px] text-slate-400">FastAPI Orchestrator</div>
                    </div>

                    <!-- 3. Secrets -->
                    <div id="node-3" class="node border-green-500/30 bg-green-900/10" style="top: 250px; left: 90px;">
                        <div class="absolute -top-2 -right-2 w-3 h-3 bg-green-500 rounded-full secure-dot"></div>
                        <div
                            class="w-10 h-10 bg-green-900/50 rounded-full mx-auto mb-2 flex items-center justify-center border border-green-500">
                            <i class="fas fa-key text-green-400"></i>
                        </div>
                        <div class="font-bold text-green-400 text-xs">Secrets Mgr</div>
                        <div class="text-[9px] text-green-300/50">Local Injection</div>
                    </div>

                    <!-- 4. FileSystem -->
                    <div id="node-4" class="node border-orange-500/30 bg-orange-900/10"
                        style="top: 300px; left: 330px;">
                        <div
                            class="w-10 h-10 bg-orange-900/50 rounded-full mx-auto mb-2 flex items-center justify-center border border-orange-500">
                            <i class="fas fa-folder-tree text-orange-400"></i>
                        </div>
                        <div class="font-bold text-orange-400 text-xs">File System</div>
                        <div class="text-[9px] text-orange-300/50">data/ & cache/</div>
                    </div>

                    <!-- 5. Agent -->
                    <div id="node-5" class="node border-pink-500/30 bg-pink-900/10" style="top: 250px; left: 570px;">
                        <div
                            class="w-10 h-10 bg-pink-900/50 rounded-full mx-auto mb-2 flex items-center justify-center border border-pink-500">
                            <i class="fas fa-robot text-pink-400"></i>
                        </div>
                        <div class="font-bold text-pink-400 text-xs">Explorer Agent</div>
                        <div class="text-[9px] text-pink-300/50">Browser-Use</div>
                    </div>

                    <!-- 6. Browser -->
                    <div id="node-6" class="node" style="top: 450px; left: 330px;">
                        <div
                            class="w-10 h-10 bg-slate-800 rounded-full mx-auto mb-2 flex items-center justify-center border border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)]">
                            <i class="fab fa-chrome text-blue-400"></i>
                        </div>
                        <div class="font-bold text-white text-xs">Browser</div>
                        <div class="text-[9px] text-slate-400">Playwright (Headed)</div>
                    </div>

                    <!-- 7. LLM -->
                    <div id="node-7" class="node border-purple-500/30 bg-purple-900/10"
                        style="top: 450px; left: 570px;">
                        <div
                            class="w-10 h-10 bg-purple-900/50 rounded-full mx-auto mb-2 flex items-center justify-center border border-purple-500">
                            <i class="fas fa-brain text-purple-400"></i>
                        </div>
                        <div class="font-bold text-purple-400 text-xs">LLM API</div>
                        <div class="text-[9px] text-purple-300/50">Gemini / Claude</div>
                    </div>

                    <!-- 8. Subprocess -->
                    <div id="node-8" class="node hidden border-indigo-500/30 bg-indigo-900/10"
                        style="top: 300px; left: 210px;">
                        <div
                            class="w-10 h-10 bg-indigo-900/50 rounded-full mx-auto mb-2 flex items-center justify-center border border-indigo-500">
                            <i class="fas fa-terminal text-indigo-400"></i>
                        </div>
                        <div class="font-bold text-indigo-400 text-xs">Subprocess</div>
                        <div class="text-[9px] text-indigo-300/50">Isolated Python</div>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT: DETAILS PANEL -->
        <div class="w-4/12 bg-slate-900 border-l border-slate-800 flex flex-col shadow-2xl relative z-30">

            <!-- Navigator -->
            <div class="p-6 border-b border-slate-800 bg-slate-900/95 backdrop-blur">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1"
                            id="flow-label">Generation Flow</div>
                        <h2 id="step-title" class="text-xl font-bold text-white">System Ready</h2>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-mono font-bold text-blue-500" id="step-num">00</div>
                        <div class="text-[10px] text-slate-500 uppercase">Step</div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="reset()"
                        class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-400 hover:text-white text-xs font-bold uppercase tracking-wide transition-all">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button onclick="nextStep()" id="btn-next"
                        class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold uppercase tracking-wide shadow-lg shadow-blue-900/20 transition-all">
                        Next Step <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar bg-[#0B1120] p-6">

                <!-- Explanation Card -->
                <div id="info-card"
                    class="detail-card p-5 rounded-r-lg rounded-bl-lg mb-6 hidden opacity-0 transition-opacity duration-500">
                    <div class="flex items-start gap-3 mb-3">
                        <i id="info-icon" class="fas fa-info-circle mt-1 text-blue-400"></i>
                        <div>
                            <h3 class="font-bold text-slate-200 text-sm">Operation Detail</h3>
                            <p id="info-text" class="text-xs text-slate-400 mt-1 leading-relaxed"></p>
                        </div>
                    </div>

                    <!-- Metadata Grid -->
                    <div class="grid grid-cols-2 gap-2 mt-4 pt-4 border-t border-slate-700/50">
                        <div>
                            <div class="text-[9px] uppercase text-slate-500 font-bold">Code Location</div>
                            <div id="meta-file" class="text-xs text-blue-300 font-mono truncate">src/main.py</div>
                        </div>
                        <div>
                            <div class="text-[9px] uppercase text-slate-500 font-bold">Protocol</div>
                            <div id="meta-proto" class="text-xs text-slate-300 font-mono">Internal Call</div>
                        </div>
                    </div>
                </div>

                <!-- Code Inspector -->
                <div class="relative group">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest"><i
                                class="fas fa-code mr-1"></i> Payload Inspector</span>
                        <span id="secure-badge"
                            class="hidden text-[9px] bg-green-500/10 text-green-400 px-2 py-0.5 rounded border border-green-500/20 uppercase font-bold">Encrypted</span>
                    </div>
                    <div class="code-block font-mono text-[10px] overflow-x-auto max-h-[400px]">
                        <pre id="code-content" class="whitespace-pre-wrap text-slate-400">// Waiting for input...</pre>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        let activeFlow = 'generation';
        let currentStep = 0;

        // --- FLOW 1: GENERATION STEPS ---
        const genSteps = [
            {
                title: "1. User Request",
                text: "The user clicks 'Launch Explorer Agent'. The frontend wraps the suite name, URL, and credentials into a JSON payload and POSTs it to the backend.",
                file: "templates/index.html (Line 272)",
                proto: "HTTP POST",
                nodes: ['node-1', 'node-2'],
                path: 'p-1',
                code: `<span class="c">// Frontend -> Backend Payload</span>
{
  <span class="k">"suite_name"</span>: <span class="s">"Smoke Test A"</span>,
  <span class="k">"url"</span>: <span class="s">"https://saucedemo.com"</span>,
  <span class="k">"auth"</span>: {
    <span class="k">"username"</span>: <span class="s">"standard_user"</span>,
    <span class="k">"password"</span>: <span class="s">"secret_sauce"</span>
  }
}`,
                secure: true
            },
            {
                title: "2. Secrets Initialization",
                text: "The Server initializes the <code>SecretsManager</code>. Credentials are extracted from the request and stored in local memory variables. They are NOT written to logs.",
                file: "src/core/server.py (Line 77)",
                proto: "Internal Object",
                nodes: ['node-2', 'node-3'],
                path: 'p-2',
                code: `<span class="c"># Initialize Secrets Manager</span>
secrets = SecretsManager(
    username=req.username,
    password=req.password,
    login_url=req.url
)
<span class="c"># Credentials are now isolated in this instance.</span>`,
                secure: true
            },
            {
                title: "3a. Session Cache Check",
                text: "<strong>Optimization:</strong> Before launching a fresh browser, the SecretsManager checks <code>data/auth_cache/</code> for a valid session file for this user.",
                file: "src/core/secrets_manager.py (Line 111)",
                proto: "File Read",
                nodes: ['node-3', 'node-4'],
                path: 'p-3a',
                code: `<span class="f">async def</span> try_load_cached_session(self, page):
    cache_file = Path(f<span class="s">"data/auth_cache/{self.username_hash}.json"</span>)
    <span class="k">if</span> cache_file.exists():
        cookies = json.load(open(cache_file))
        <span class="f">await</span> page.context.add_cookies(cookies)
        <span class="k">return</span> <span class="k">True</span> <span class="c"># Hit!</span>
    <span class="k">return</span> <span class="k">False</span> <span class="c"># Miss</span>`,
                secure: true,
                type: "fs"
            },
            {
                title: "3b. Credential Injection",
                text: "<strong>Fallback (Cache Miss):</strong> If no session exists, SecretsManager drives Playwright directly to fill the login form. <strong>The AI Agent is NOT involved.</strong>",
                file: "src/core/secrets_manager.py (Line 11)",
                proto: "Playwright Protocol",
                nodes: ['node-3', 'node-6'],
                path: 'p-3b',
                code: `<span class="f">async def</span> inject_login(page):
    <span class="c"># ZERO-TRUST: Direct DOM access</span>
    <span class="f">await</span> page.goto(self.login_url)
    <span class="f">await</span> page.fill(<span class="s">"#user-name"</span>, self.username)
    <span class="f">await</span> page.fill(<span class="s">"#password"</span>, <span class="s">"******"</span>)
    <span class="f">await</span> page.click(<span class="s">"#login-button"</span>)
    
    <span class="c"># Save new session to cache after success</span>`,
                secure: true
            },
            {
                title: "4. Initialize Agent",
                text: "Login is complete. The Server now initializes the <code>browser-use</code> Agent, passing it the <strong>Authenticated Browser Context</strong>.",
                file: "src/agents/explorer_agent.py (Line 18)",
                proto: "Object Reference",
                nodes: ['node-2', 'node-5'],
                path: 'p-4',
                code: `<span class="c"># Initialize Agent with Auth Context</span>
agent = Agent(
    task=<span class="s">"Explore & Generate Tests"</span>,
    llm=ChatGoogleGenerativeAI(<span class="s">"gemini-2.0"</span>),
    browser_context=context <span class="c"># <-- Contains auth cookies</span>
)`,
                secure: false
            },
            {
                title: "5. Visual Analysis",
                text: "The Agent takes a screenshot and extracts the Accessibility Tree. This data captures the 'State' of the application without exposing hidden input values.",
                file: "browser_use/agent.py",
                proto: "CDP (Chrome Protocol)",
                nodes: ['node-5', 'node-6'],
                path: 'p-7',
                code: `<span class="c"># Capture State</span>
screenshot = <span class="f">await</span> page.screenshot()
dom_tree = <span class="f">await</span> page.accessibility.snapshot()
<span class="c"># Note: Passwords in 'value' attributes are stripped</span>`,
                secure: false
            },
            {
                title: "6. Reasoning Loop",
                text: "The Agent sends the Screenshot + Tree to the LLM (Gemini/Claude). It asks: 'What are the key flows here?'",
                file: "api_request.json",
                proto: "REST API (HTTPS)",
                nodes: ['node-5', 'node-7'],
                path: 'p-5',
                code: `{
  <span class="k">"role"</span>: <span class="s">"user"</span>,
  <span class="k">"content"</span>: [
    { <span class="k">"type"</span>: <span class="s">"text"</span>, <span class="k">"text"</span>: <span class="s">"Task: Analyze this page."</span> },
    { <span class="k">"type"</span>: <span class="s">"image_url"</span>, <span class="k">"url"</span>: <span class="s">"data:image/png;base64,..."</span> }
  ]
}
<span class="c"># ðŸ›‘ NO PASSWORDS SENT HERE</span>`,
                secure: false
            },
            {
                title: "7. Plan Generation",
                text: "The LLM returns a JSON object containing the identified Test Cases, including steps and selectors.",
                file: "src/core/server.py",
                proto: "JSON Return",
                nodes: ['node-7', 'node-5', 'node-2'],
                path: 'p-8',
                code: `{
  <span class="k">"test_cases"</span>: [{
    <span class="k">"id"</span>: <span class="s">"TC001"</span>,
    <span class="k">"title"</span>: <span class="s">"Shopping cart checkout"</span>,
    <span class="k">"steps"</span>: [
       <span class="s">"Click 'Add to cart' using: button[data-test='add-to-cart']"</span>,
       <span class="s">"Click cart icon using: .shopping_cart_link"</span>
    ]
  }]
}`,
                secure: false
            },
            {
                title: "8. Script Generation",
                text: "The Server converts the JSON test cases into executable Python Playwright scripts and saves them to the FileSystem.",
                file: "src/generators/playwright_generator.py",
                proto: "File Write",
                nodes: ['node-2', 'node-4'],
                path: 'p-9',
                code: `<span class="c"># Generating: data/generated_tests/Smoke_Test_A_TC001.py</span>
<span class="f">async def</span> test_tc001():
    <span class="c"># ... login logic ...</span>
    <span class="f">await</span> page.click(<span class="s">"button[data-test='add-to-cart']"</span>)
    <span class="f">await</span> page.click(<span class="s">".shopping_cart_link"</span>)`,
                secure: true,
                type: "fs"
            },
            {
                title: "9. Complete",
                text: "Server returns the test cases to the UI to display in the table.",
                file: "http_response.json",
                proto: "HTTP 200 OK",
                nodes: ['node-2', 'node-1'],
                path: 'p-1',
                code: `{
  <span class="k">"status"</span>: <span class="s">"success"</span>,
  <span class="k">"cases"</span>: [ ... ]
}`,
                secure: false
            }
        ];

        // --- FLOW 2: EXECUTION STEPS ---
        const execSteps = [
            {
                title: "1. Execute Request",
                text: "User clicks 'Run' on a test case. Request includes the Test Case ID.",
                file: "templates/index.html",
                proto: "HTTP POST",
                nodes: ['node-1', 'node-2'],
                path: 'p-1',
                code: `{
  <span class="k">"suite_name"</span>: <span class="s">"Smoke Test A"</span>,
  <span class="k">"test_case_id"</span>: <span class="s">"TC001"</span>
}`,
                secure: false
            },
            {
                title: "2. Spawn Subprocess",
                text: "Server locates the generated script on disk and spawns a dedicated Python subprocess. This ensures isolation and stability.",
                file: "src/core/server.py (Line 237)",
                proto: "OS System Call",
                nodes: ['node-2', 'node-8'],
                path: 'p-10',
                code: `<span class="c"># Locate Script</span>
script_path = <span class="s">"data/generated_tests/Smoke_Test_A_TC001.py"</span>

<span class="c"># Spawn Isolated Process</span>
process = subprocess.run(
    [<span class="s">"python"</span>, script_path], 
    capture_output=<span class="k">True</span>
)`,
                secure: true
            },
            {
                title: "3. Execution",
                text: "The subprocess launches a new browser, re-injects credentials (using the same secure logic), and executes the steps.",
                file: "TC001.py",
                proto: "Playwright Protocol",
                nodes: ['node-8', 'node-6'],
                path: 'p-11',
                code: `<span class="c"># Execution Log</span>
> Launching Browser... OK
> Injecting Login... OK
> Step 1: Click 'Add'... OK
> Step 2: Click Cart... OK
> Assertion Passed.`,
                secure: true
            },
            {
                title: "4. Return Result",
                text: "Subprocess exits. Server captures stdout to determine PASS/FAIL status and returns it to UI.",
                file: "http_response.json",
                proto: "HTTP 200 OK",
                nodes: ['node-8', 'node-2', 'node-1'],
                path: 'p-1',
                code: `{
  <span class="k">"status"</span>: <span class="s">"success"</span>,
  <span class="k">"result"</span>: <span class="s">"PASS"</span>
}`,
                secure: false
            }
        ];

        // ================= LOGIC =================

        function setFlow(flow) {
            activeFlow = flow;
            currentStep = 0;

            // UI Updates
            const isGen = flow === 'generation';
            document.getElementById('tab-gen').className = isGen ? "px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-blue-600 text-white shadow-md flex items-center gap-2" : "px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition-all flex items-center gap-2";
            document.getElementById('tab-exec').className = !isGen ? "px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-purple-600 text-white shadow-md flex items-center gap-2" : "px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition-all flex items-center gap-2";

            // Label Update
            document.getElementById('flow-label').innerText = isGen ? "Generation Flow" : "Execution Flow";

            // Node Visibility
            const subNode = document.getElementById('node-8');
            if (!isGen) subNode.classList.remove('hidden');
            else subNode.classList.add('hidden');

            updateUI();
        }

        function nextStep() {
            const data = activeFlow === 'generation' ? genSteps : execSteps;
            if (currentStep < data.length) {
                currentStep++;
                updateUI();
            }
        }

        function reset() {
            currentStep = 0;
            updateUI();
        }

        function updateUI() {
            const data = activeFlow === 'generation' ? genSteps : execSteps;
            const stepIndex = currentStep - 1;

            // Reset Visuals
            document.querySelectorAll('.node').forEach(n => n.className = 'node'); // Clear active classes
            // Restore hidden/base classes logic
            if (activeFlow === 'generation') document.getElementById('node-8').classList.add('hidden');
            else document.getElementById('node-8').classList.remove('hidden');

            // Node specific base styles
            document.getElementById('node-3').classList.add('border-green-500/30', 'bg-green-900/10');
            document.getElementById('node-4').classList.add('border-orange-500/30', 'bg-orange-900/10');
            document.getElementById('node-5').classList.add('border-pink-500/30', 'bg-pink-900/10');
            document.getElementById('node-7').classList.add('border-purple-500/30', 'bg-purple-900/10');
            document.getElementById('node-8').classList.add('border-indigo-500/30', 'bg-indigo-900/10');

            document.querySelectorAll('.connector-path').forEach(p => {
                p.classList.remove('active', 'secure', 'exec');
                p.style.markerEnd = "";
            });

            document.getElementById('secure-badge').classList.add('hidden');
            document.getElementById('packet').classList.remove('animating');

            // Init State
            if (currentStep === 0) {
                document.getElementById('step-num').innerText = "00";
                document.getElementById('step-title').innerText = "Ready to Start";
                document.getElementById('info-card').classList.add('hidden', 'opacity-0');
                document.getElementById('code-content').innerHTML = '// Waiting...';
                document.getElementById('btn-next').innerHTML = `Next Step <i class="fas fa-chevron-right"></i>`;
                return;
            }

            const step = data[stepIndex];

            // Update Text
            document.getElementById('step-num').innerText = `0${currentStep}`;
            document.getElementById('step-title').innerText = step.title;
            document.getElementById('info-text').innerHTML = step.text;
            document.getElementById('meta-file').innerText = step.file;
            document.getElementById('meta-proto').innerText = step.proto;
            document.getElementById('code-content').innerHTML = step.code;

            // Button State
            document.getElementById('btn-next').innerHTML = currentStep === data.length ?
                `Finish <i class="fas fa-check"></i>` : `Next Step <i class="fas fa-chevron-right"></i>`;

            // Show Card
            const card = document.getElementById('info-card');
            card.classList.remove('hidden');
            setTimeout(() => card.classList.remove('opacity-0'), 10);

            // Card Style based on type
            card.className = "detail-card p-5 rounded-r-lg rounded-bl-lg mb-6"; // Reset
            if (step.secure) {
                card.classList.add('secure');
                document.getElementById('secure-badge').classList.remove('hidden');
                document.getElementById('info-icon').className = "fas fa-shield-alt mt-1 text-green-400";
            } else if (step.type === 'fs') {
                card.classList.add('fs');
                document.getElementById('secure-badge').classList.add('hidden');
                document.getElementById('info-icon').className = "fas fa-save mt-1 text-orange-400";
            } else {
                card.classList.add('ai');
                document.getElementById('secure-badge').classList.add('hidden');
                document.getElementById('info-icon').className = "fas fa-robot mt-1 text-purple-400";
            }

            // Activate Nodes
            step.nodes.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('active');
                    if (step.secure) el.classList.add('secure-active');
                    else if (step.type === 'fs') el.classList.add('fs-active');
                    else el.classList.add('ai-active');
                }
            });

            // Activate Path & Packet
            if (step.path) {
                const p = document.getElementById(step.path);
                if (p) {
                    p.classList.add('active');
                    if (step.secure) {
                        p.classList.add('secure');
                        p.style.markerEnd = "url(#arrow-green)";
                    } else if (activeFlow === 'execution') {
                        p.classList.add('exec');
                        p.style.markerEnd = "url(#arrow-purple)";
                    } else {
                        p.style.markerEnd = "url(#arrow-blue)";
                    }

                    // Animate packet
                    const anim = document.getElementById('packet-anim');
                    anim.setAttribute('href', '#' + step.path);
                    document.getElementById('packet').classList.add('animating');
                }
            }
        }

        // Init
        setFlow('generation');
    </script>
</body>

</html>