<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Agent Data Flow | Technical Deep Dive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Node Styling */
        .node {
            position: absolute;
            width: 160px;
            padding: 0.75rem;
            border-radius: 0.75rem;
            background-color: #0f172a;
            border: 1px solid #334155;
            text-align: center;
            transition: all 0.4s ease;
            z-index: 10;
            opacity: 0.5;
            filter: grayscale(0.8);
        }

        .node.active {
            transform: scale(1.1);
            border-color: #3b82f6;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.3);
            background-color: #1e293b;
            opacity: 1;
            filter: grayscale(0);
        }

        .node.secure-active {
            border-color: #10b981;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.3);
        }

        .node.opt-active {
            border-color: #f59e0b;
            /* Amber for Optimization */
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.3);
        }

        .node.exec-active {
            border-color: #8b5cf6;
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.3);
        }

        /* SVG Styling */
        .flow-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .connector {
            fill: none;
            stroke: #334155;
            stroke-width: 1;
            stroke-dasharray: 5;
            opacity: 0.2;
            transition: all 0.4s ease;
        }

        .connector.active {
            stroke: #3b82f6;
            stroke-width: 3;
            stroke-dasharray: 0;
            opacity: 1;
            filter: drop-shadow(0 0 3px #3b82f6);
        }

        .connector.secure {
            stroke: #10b981;
            filter: drop-shadow(0 0 3px #10b981);
        }

        .connector.opt {
            stroke: #f59e0b;
            filter: drop-shadow(0 0 3px #f59e0b);
        }

        .connector.exec {
            stroke: #8b5cf6;
            filter: drop-shadow(0 0 3px #8b5cf6);
        }

        @keyframes flowPulse {
            0% {
                stroke-dashoffset: 20;
            }

            100% {
                stroke-dashoffset: 0;
            }
        }

        .connector.active {
            animation: flowPulse 1s linear infinite;
        }

        /* Terminal Window */
        .terminal {
            background-color: #020617;
            border: 1px solid #1e293b;
            box-shadow: inset 0 0 20px #000000;
        }

        /* Syntax Highlighting */
        .key {
            color: #f43f5e;
        }

        .string {
            color: #a5f3fc;
        }

        .number {
            color: #06b6d4;
        }

        .comment {
            color: #64748b;
            font-style: italic;
        }

        .func {
            color: #8b5cf6;
        }

        .keyword {
            color: #f59e0b;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="border-b border-slate-800 bg-slate-900 p-4 flex justify-between items-center z-20 shadow-lg">
        <div class="flex items-center gap-4">
            <div class="p-2 bg-slate-800 rounded-lg">
                <i class="fas fa-network-wired text-blue-400"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">AI Agent Architecture <span
                        class="text-slate-500">|</span> Data Flow Sim</h1>
                <div class="flex gap-4 text-[10px] uppercase tracking-widest font-semibold mt-1">
                    <div class="flex items-center gap-1 text-green-400">
                        <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></div>
                        Secure Zone
                    </div>
                    <div class="flex items-center gap-1 text-amber-400">
                        <div class="w-2 h-2 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.6)]"></div>
                        Optimization
                    </div>
                    <div class="flex items-center gap-1 text-blue-400">
                        <div class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"></div> Cloud
                        Zone
                    </div>
                </div>
            </div>
        </div>

        <!-- Flow Switcher -->
        <div class="flex bg-slate-950 p-1 rounded-lg border border-slate-700">
            <button onclick="switchFlow('generation')" id="btn-gen"
                class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow-lg">
                <i class="fas fa-magic mr-2"></i>1. Generation Flow
            </button>
            <button onclick="switchFlow('execution')" id="btn-exec"
                class="px-4 py-2 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all">
                <i class="fas fa-play mr-2"></i>2. Execution Flow
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">

        <!-- LEFT: Visual Architecture -->
        <div class="w-8/12 relative bg-slate-950 flex flex-col justify-center items-center overflow-hidden group">

            <!-- Grid Background -->
            <div class="absolute inset-0"
                style="background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px); background-size: 40px 40px; opacity: 0.15;">
            </div>

            <!-- DIAGRAM CONTAINER -->
            <div class="relative w-[900px] h-[600px] scale-90 origin-center transition-transform duration-700">

                <!-- SVG Layer for Connectors -->
                <svg class="flow-lines" viewBox="0 0 900 600">
                    <defs>
                        <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" />
                        </marker>
                        <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <path d="M0,0 L0,6 L9,3 z" fill="#10b981" />
                        </marker>
                        <marker id="arrow-amber" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <path d="M0,0 L0,6 L9,3 z" fill="#f59e0b" />
                        </marker>
                        <marker id="arrow-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <path d="M0,0 L0,6 L9,3 z" fill="#8b5cf6" />
                        </marker>
                    </defs>

                    <!-- Shared Paths -->
                    <path id="p-user-server" d="M450,60 L450,120" class="connector" />

                    <!-- Generation Paths -->
                    <!-- Server to Secrets: (450,180) to (200,310) -->
                    <path id="p-server-secrets" class="connector" d="M450,180 C350,180 250,250 200,310" />

                    <!-- Secrets to FS (Cache Check): (200,310) to (450,310) -->
                    <path id="p-secrets-fs" class="connector" d="M260,310 L370,310" />

                    <!-- Secrets to Browser: (200,310) to (450,510) -->
                    <path id="p-secrets-browser" class="connector" d="M200,370 L200,440 C200,480 370,480 450,480" />

                    <!-- Server to Agent: (450,180) to (700,310) -->
                    <path id="p-server-agent" class="connector" d="M450,180 C550,180 650,250 700,310" />

                    <!-- Agent to Browser: (700,310) to (450,510) -->
                    <path id="p-agent-browser" class="connector" d="M700,370 C700,440 540,440 450,480" />

                    <!-- Agent to LLM: (700,310) to (700,510) -->
                    <path id="p-agent-llm" class="connector" d="M700,370 L700,450" />

                    <!-- Agent to Server return: (700,310) to (450,180) -->
                    <path id="p-agent-server" class="connector" d="M700,250 C600,200 500,180 500,180" />

                    <!-- Server to FS: (450,180) to (450,310) -->
                    <path id="p-server-fs" class="connector" d="M450,240 L450,250" />

                    <!-- Execution Paths -->
                    <!-- Server to Subprocess: (450,180) to (300,340) -->
                    <path id="p-server-subprocess" class="connector" d="M390,180 C330,180 300,250 300,280" />

                    <!-- Subprocess to Browser: (300,340) to (450,510) -->
                    <path id="p-subprocess-browser" class="connector" d="M340,340 C360,400 390,440 430,480" />

                    <!-- Subprocess to Server return: (300,340) to (450,180) -->
                    <path id="p-subprocess-server" class="connector" d="M340,300 C360,220 390,190 410,180" />
                    <!-- Result -->
                </svg>

                <!-- NODES -->
                <!-- 1. User UI -->
                <div id="node-user" class="node" style="top: 0px; left: 370px;">
                    <i class="fas fa-desktop text-2xl text-blue-400 mb-1"></i>
                    <div class="font-bold text-white text-sm">User UI</div>
                    <div class="text-[10px] text-slate-500">Inputs & Results</div>
                </div>

                <!-- 2. Server -->
                <div id="node-server" class="node" style="top: 120px; left: 370px;">
                    <i class="fas fa-server text-2xl text-indigo-400 mb-1"></i>
                    <div class="font-bold text-white text-sm">Backend API</div>
                    <div class="text-[10px] text-slate-500">FastAPI / Orchestrator</div>
                </div>

                <!-- 3. Secrets (Left) -->
                <div id="node-secrets" class="node border-green-900/50 bg-green-900/10"
                    style="top: 250px; left: 120px;">
                    <i class="fas fa-user-shield text-2xl text-green-400 mb-1"></i>
                    <div class="font-bold text-green-400 text-sm">Secrets Mgr</div>
                    <div class="text-[10px] text-green-200/50">Zero-Trust Injection</div>
                </div>

                <!-- 4. FileSystem (Center) -->
                <div id="node-fs" class="node" style="top: 250px; left: 370px;">
                    <i class="fas fa-folder-tree text-2xl text-yellow-400 mb-1"></i>
                    <div class="font-bold text-white text-sm">FileSystem</div>
                    <div class="text-[10px] text-slate-500">Auth Cache & Scripts</div>
                </div>

                <!-- 5. Agent (Right) -->
                <div id="node-agent" class="node border-pink-900/50 bg-pink-900/10" style="top: 250px; left: 620px;">
                    <i class="fas fa-robot text-2xl text-pink-400 mb-1"></i>
                    <div class="font-bold text-pink-400 text-sm">Explorer Agent</div>
                    <div class="text-[10px] text-pink-200/50">Browser-Use Lib</div>
                </div>

                <!-- 6. Subprocess (Execution Only) -->
                <div id="node-subprocess" class="node border-purple-900/50 bg-purple-900/10 hidden"
                    style="top: 280px; left: 220px;">
                    <i class="fas fa-terminal text-2xl text-purple-400 mb-1"></i>
                    <div class="font-bold text-purple-400 text-sm">Subprocess</div>
                    <div class="text-[10px] text-purple-200/50">Isolated Execution</div>
                </div>

                <!-- 7. Browser (Bottom Center) -->
                <div id="node-browser" class="node" style="top: 450px; left: 370px;">
                    <i class="fab fa-chrome text-3xl text-orange-400 mb-1"></i>
                    <div class="font-bold text-white text-sm">Browser</div>
                    <div class="text-[10px] text-slate-500">Playwright (CDP)</div>
                </div>

                <!-- 8. LLM (Bottom Right) -->
                <div id="node-llm" class="node border-blue-900/50 bg-blue-900/10" style="top: 450px; left: 620px;">
                    <i class="fas fa-brain text-2xl text-blue-400 mb-1"></i>
                    <div class="font-bold text-blue-400 text-sm">LLM API</div>
                    <div class="text-[10px] text-blue-200/50">Cloud Inference</div>
                </div>

                <!-- Security Badges -->
                <div id="secure-badge"
                    class="absolute bottom-10 left-10 bg-green-900/80 border border-green-500 text-green-300 px-3 py-1 rounded text-xs opacity-0 transition-opacity duration-500">
                    <i class="fas fa-lock mr-2"></i>SECURE CONTEXT
                </div>
            </div>
        </div>

        <!-- RIGHT: Data Inspector -->
        <div class="w-4/12 bg-slate-900 border-l border-slate-700 flex flex-col shadow-2xl z-20">
            <!-- Step Controller -->
            <div class="p-6 border-b border-slate-800 bg-slate-800/80 backdrop-blur-md">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs font-bold text-blue-400 uppercase tracking-wider" id="flow-title">FLOW 1:
                        GENERATION</div>
                    <div class="text-xs text-slate-500" id="step-indicator">Step 0 of 9</div>
                </div>
                <h2 class="text-lg font-bold text-white mb-4 min-h-[3.5rem]" id="step-headline">Ready to start
                    simulation.</h2>
                <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden mb-6">
                    <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500 w-0"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="reset()"
                        class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-300 text-sm transition-all font-medium group">
                        <i class="fas fa-undo group-hover:-rotate-180 transition-transform duration-500"></i> Reset
                    </button>
                    <button onclick="nextStep()" id="next-btn"
                        class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-500/20 transition-all group">
                        Next Step <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- Details Panel -->
            <div class="flex-1 p-6 overflow-y-auto bg-[#0B1120] custom-scrollbar">
                <div class="mb-6">
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Operation Details
                    </h3>
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                        <div id="detail-content" class="text-sm text-slate-300 space-y-2">
                            <p>Select a flow and click start to begin the trace.</p>
                        </div>
                    </div>
                </div>
                <!-- Data Payload -->
                <div>
                    <div class="flex items-center justify-between mb-2 cursor-pointer" onclick="toggleCode()">
                        <h3
                            class="text-xs font-semibold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-code"></i> Data Payload
                        </h3>
                        <i id="code-chevron"
                            class="fas fa-chevron-down text-slate-500 text-xs transition-transform"></i>
                    </div>
                    <div id="code-container"
                        class="terminal rounded-lg border border-slate-800 overflow-hidden transition-all duration-300 max-h-[400px]">
                        <div
                            class="bg-slate-900/50 px-3 py-1 border-b border-slate-800 flex justify-between items-center">
                            <span class="text-[10px] text-slate-500 font-mono" id="file-path">system.log</span>
                            <div class="flex gap-1">
                                <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                                <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                            </div>
                        </div>
                        <div class="p-4 font-mono text-xs overflow-x-auto">
                            <pre id="code-display"
                                class="leading-relaxed text-slate-400 bg-transparent">// Waiting...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= STATE MANAGEMENT =================
        let activeFlow = 'generation';
        let currentStep = 0;
        let isCodeExpanded = true;

        // ================= DATA MODELS (Based on End_to_End_Flows.html) =================

        const generationSteps = [
            {
                // STEP 1
                nodes: ['node-user', 'node-server'],
                lines: ['p-user-server'],
                headline: "User Initiates Generation",
                desc: "User clicks 'Launch Explorer'. Config and Suite metadata sent to Backend.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Endpoint:</span><code class="text-blue-300">POST /api/generate</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/core/server.py:92-120</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-purple-300">HTTP/1.1</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Content-Type:</span><code class="text-yellow-300">application/json</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Response Code:</span><code class="text-green-400">200 OK</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Latency:</span><code class="text-amber-300">~50ms</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Payload Size:</span><code class="text-cyan-300">~2KB</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Security:</span><code class="text-red-300">Credentials NOT in payload</code></div>
                    </div>
                `,
                path: "http_payload.json",
                code: `{
  <span class="key">"suite_name"</span>: <span class="string">"Smoke Test A"</span>,
  <span class="key">"url"</span>: <span class="string">"https://saucedemo.com"</span>,
  <span class="key">"goal"</span>: <span class="string">"Verify shopping cart flow"</span>,
  <span class="key">"credentials"</span>: <span class="comment">// Handled via SecretsManager (env vars)</span>
  <span class="comment">// Schema: { suite_name: str, url: str, goal: str }</span>
}`,
                style: "normal"
            },
            {
                // STEP 2
                nodes: ['node-server', 'node-secrets'],
                lines: ['p-server-secrets'],
                headline: "Server Init & Secrets Setup",
                desc: "Backend initializes the SecretsManager using environment variables. No credentials are persisted to DB.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/core/server.py:98-105</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Secrets Class:</span><code class="text-purple-300">src/core/secrets_manager.py:15-85</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-yellow-300">Local Memory (No Network)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Data Source:</span><code class="text-cyan-300">os.environ via python-dotenv</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Security Model:</span><code class="text-green-400">Zero-Trust (Env Isolation)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Execution Time:</span><code class="text-amber-300">~2ms</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Error Handling:</span><code class="text-red-300">Raises ValueError if missing</code></div>
                    </div>
                `,
                path: "server.py",
                code: `<span class="comment"># Initialize Secrets (Zero-Trust)</span>
<span class="comment"># Location: src/core/server.py:98-105</span>
secrets = SecretsManager(
    username=os.getenv(<span class="string">"APP_USERNAME"</span>),  <span class="comment"># From .env file</span>
    password=os.getenv(<span class="string">"APP_PASSWORD"</span>)   <span class="comment"># Never hardcoded</span>
)
<span class="comment"># Security: Credentials stay in memory, never logged</span>
<span class="comment"># Validated: Raises error if None</span>`,
                style: "secure"
            },
            {
                // STEP 3
                nodes: ['node-server', 'node-agent', 'node-browser'],
                lines: ['p-server-agent', 'p-agent-browser'],
                headline: "Agent & Browser Init",
                desc: "Explorer Agent initializes the browser instance. Configures headless mode and security flags.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/agents/explorer_agent.py:40-55</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Browser Library:</span><code class="text-purple-300">browser-use v0.1.11</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-blue-300">Chrome DevTools Protocol (CDP)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Playwright Version:</span><code class="text-cyan-300">v1.40.0</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Browser Engine:</span><code class="text-orange-300">Chromium 120.0</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Security Flags:</span><code class="text-red-300">--disable-password-manager</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Launch Time:</span><code class="text-amber-300">~800ms</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Context:</span><code class="text-green-400">Isolated (no shared state)</code></div>
                    </div>
                `,
                path: "explorer_agent.py",
                code: `<span class="comment"># Location: src/agents/explorer_agent.py:40-55</span>
browser = Browser(
    headless=<span class="keyword">False</span>,   <span class="comment"># Visual mode for debugging</span>
    highlight_elements=<span class="keyword">True</span>,  <span class="comment"># Highlight interactions</span>
    args=[
        <span class="string">"--disable-password-manager"</span>,  <span class="comment"># Security</span>
        <span class="string">"--no-first-run"</span>,             <span class="comment"># Skip welcome</span>
        <span class="string">"--no-default-browser-check"</span>  <span class="comment"># Skip check</span>
    ]
)
<span class="func">await</span> browser.start()  <span class="comment"># ~800ms startup</span>`,
                style: "normal"
            },
            {
                // STEP 3a (NEW OPTIMIZATION)
                nodes: ['node-secrets', 'node-fs'],
                lines: ['p-secrets-fs'],
                headline: "Step 3a: Session Cache Check ⚡",
                desc: "SecretsManager checks FileSystem for a valid session cookie to skip login.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/core/secrets_manager.py:47-68</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Function:</span><code class="text-purple-300">try_load_cached_session()</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-yellow-300">File I/O (JSON)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Cache Location:</span><code class="text-cyan-300">data/auth_cache/{hash}.json</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Performance:</span><code class="text-green-400">~5ms (if cached), saves 3-5s login</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">TTL Strategy:</span><code class="text-amber-300">Session-based (no expiry)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Cache Hit Rate:</span><code class="text-pink-300">~70% in practice</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Optimization:</span><code class="text-orange-300">60-80% faster on re-runs</code></div>
                    </div>
                `,
                path: "secrets_manager.py",
                code: `<span class="comment">// Location: src/core/secrets_manager.py:47-68</span>
<span class="func">async def</span> try_load_cached_session(page):
    cache_file = <span class="string">f"data/auth_cache/{user_hash}.json"</span>
    <span class="keyword">if</span> os.path.exists(cache_file):  <span class="comment"># ~1ms check</span>
        cookies = json.load(cache_file)  <span class="comment"># ~3ms</span>
        <span class="func">await</span> page.context.add_cookies(cookies)  <span class="comment"># ~1ms</span>
        <span class="keyword">return</span> <span class="keyword">True</span> <span class="comment"># ⚡ CACHE HIT - Skip login!</span>
    <span class="keyword">return</span> <span class="keyword">False</span> <span class="comment"># ❌ CACHE MISS - Need fresh login</span>`,
                style: "opt"
            },
            {
                // STEP 4 (Fallback)
                nodes: ['node-secrets', 'node-browser'],
                lines: ['p-secrets-browser'],
                headline: "Step 4: Secure Credential Injection",
                desc: "If Cache Miss: SecretsManager drives browser to log in. <strong>Credentials NEVER sent to LLM.</strong>",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/core/secrets_manager.py:70-92</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Function:</span><code class="text-purple-300">inject_credentials_and_login()</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-blue-300">CDP (Chrome DevTools Protocol)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Method:</span><code class="text-yellow-300">Direct DOM Manipulation</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Security Model:</span><code class="text-red-400">Zero-Trust (No LLM Access)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Execution Time:</span><code class="text-amber-300">~3-5s (network dependent)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Selectors:</span><code class="text-cyan-300">Auto-detected from page</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Error Handling:</span><code class="text-pink-300">Retries 3x with backoff</code></div>
                    </div>
                `,
                path: "secrets_manager.py",
                code: `<span class="comment">// Location: src/core/secrets_manager.py:70-92</span>
<span class="comment">// ZERO-TRUST: Credentials bypass AI Agent completely</span>
<span class="func">await</span> page.fill(<span class="string">"#user-name"</span>, self.username)  <span class="comment">// Direct injection</span>
<span class="func">await</span> page.fill(<span class="string">"#password"</span>, self.password)   <span class="comment">// Never logged</span>
<span class="func">await</span> page.click(<span class="string">"#login-button"</span>)          <span class="comment">// Submit</span>
<span class="func">await</span> page.wait_for_url(<span class="string">"**/inventory.html"</span>)  <span class="comment">// Verify</span>
<span class="func">await</span> page.keyboard.press(<span class="string">"Escape"</span>)  <span class="comment">// Dismiss alerts</span>
<span class="comment">// Save session for future cache hit</span>
cookies = <span class="func">await</span> page.context.cookies()
save_to_cache(cookies)  <span class="comment">// ~5ms write</span>`,
                style: "secure"
            },
            {
                // STEP 5
                nodes: ['node-agent', 'node-llm'],
                lines: ['p-agent-llm'],
                headline: "Agent Exploration Loop",
                desc: "Agent captures screenshot/DOM (post-login) and asks LLM for next action.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/agents/explorer_agent.py:75-145</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">LLM Provider:</span><code class="text-purple-300">Gemini 1.5 Flash / GPT-4o</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-blue-300">HTTPS/2 (TLS 1.3)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">API Endpoint:</span><code class="text-yellow-300">generativelanguage.googleapis.com</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Data Sent:</span><code class="text-cyan-300">Screenshots (base64) + Text Goal</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Security:</span><code class="text-green-400">NO credentials in payload</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Request Latency:</span><code class="text-amber-300">~800ms-2s per call</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Tokens Per Call:</span><code class="text-pink-300">~2K input, ~200 output</code></div>
                    </div>
                `,
                path: "api_request.json",
                code: `<span class="comment">// Gemini API Request Structure</span>
{
  <span class="key">"model"</span>: <span class="string">"gemini-1.5-flash"</span>,
  <span class="key">"contents"</span>: [{
    <span class="key">"role"</span>: <span class="string">"user"</span>,
    <span class="key">"parts"</span>: [
      { <span class="key">"text"</span>: <span class="string">"Goal: Verify cart. What next?"</span> },
      { <span class="key">"inline_data"</span>: {
          <span class="key">"mime_type"</span>: <span class="string">"image/png"</span>,
          <span class="key">"data"</span>: <span class="string">"iVBORw0KGgo..."</span> <span class="comment">// base64</span>
        }
      }
    ]
  }]
}`,
                style: "normal"
            },
            {
                // STEP 6
                nodes: ['node-llm', 'node-agent', 'node-browser'],
                lines: ['p-agent-llm', 'p-agent-browser'],
                headline: "LLM Directs Browser",
                desc: "LLM analyzes UI and returns Playwright commands. Agent executes them.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/agents/explorer_agent.py:150-180</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Action Types:</span><code class="text-purple-300">click, type, scroll, navigate</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-blue-300">CDP (Browser Control)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Response Format:</span><code class="text-yellow-300">JSON (thought + action)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Parsing:</span><code class="text-cyan-300">JSON schema validation</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Loop Duration:</span><code class="text-amber-300">25-35s (5-8 iterations)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Stop Condition:</span><code class="text-green-400">Goal achieved OR max steps</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Action Execution:</span><code class="text-pink-300">~200-500ms per action</code></div>
                    </div>
                `,
                path: "api_response.json",
                code: `<span class="comment">// LLM Response Example</span>
{
  <span class="key">"candidates"</span>: [{
    <span class="key">"content"</span>: {
      <span class="key">"thought"</span>: <span class="string">"I see the inventory page with products."</span>,
      <span class="key">"action"</span>: {
        <span class="key">"type"</span>: <span class="string">"click"</span>,  <span class="comment">// Action enum</span>
        <span class="key">"selector"</span>: <span class="string">"#add-to-cart-sauce-labs-backpack"</span>
      }
    }
  }]
}
<span class="comment">// Agent executes: await page.click(selector)</span>`,
                style: "normal"
            },
            {
                // STEP 7
                nodes: ['node-agent', 'node-server'],
                lines: ['p-agent-server'],
                headline: "Test Case Generation",
                desc: "Agent finalizes exploration and returns structured JSON test cases to Server.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/agents/explorer_agent.py:185-220</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Generator:</span><code class="text-purple-300">src/generators/playwright_generator.py</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-yellow-300">Internal (Python objects)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Output Format:</span><code class="text-cyan-300">JSON (test case schema)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Test Cases:</span><code class="text-green-400">3-5 scenarios per session</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Steps Per Test:</span><code class="text-amber-300">5-12 actions average</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Generation Time:</span><code class="text-pink-300">~200ms (JSON serialization)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Data Size:</span><code class="text-orange-300">~5-10KB per test case</code></div>
                    </div>
                `,
                path: "agent_output.json",
                code: `<span class="comment">// Test Case Schema</span>
{
  <span class="key">"test_cases"</span>: [{
    <span class="key">"id"</span>: <span class="string">"TC001"</span>,
    <span class="key">"title"</span>: <span class="string">"Add to Cart Flow"</span>,
    <span class="key">"priority"</span>: <span class="string">"high"</span>,
    <span class="key">"steps"</span>: [
      { <span class="key">"action"</span>: <span class="string">"click"</span>, <span class="key">"selector"</span>: <span class="string">"#add-to-cart"</span> },
      { <span class="key">"action"</span>: <span class="string">"click"</span>, <span class="key">"selector"</span>: <span class="string">".shopping_cart_link"</span> }
    ],
    <span class="key">"metadata"</span>: { <span class="key">"duration"</span>: <span class="number">35</span>, <span class="key">"coverage"</span>: <span class="number">85</span> }
  }]
}`,
                style: "normal"
            },
            {
                // STEP 8
                nodes: ['node-server', 'node-fs'],
                lines: ['p-server-fs'],
                headline: "Persist Scripts & Data",
                desc: "Server generates Python Playwright scripts and saves them to FileSystem.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/generators/playwright_generator.py:25-95</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Template Engine:</span><code class="text-purple-300">Jinja2 (Python templating)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-yellow-300">File I/O (Write)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Output Directory:</span><code class="text-cyan-300">data/generated_tests/{suite}/</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">File Naming:</span><code class="text-green-400">{suite_name}_{test_id}.py</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Write Time:</span><code class="text-amber-300">~10-20ms per file</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">File Size:</span><code class="text-pink-300">~2-5KB per test script</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Permissions:</span><code class="text-orange-300">0644 (read/write owner)</code></div>
                    </div>
                `,
                path: "data/generated_tests/TC001.py",
                code: `<span class="comment"># Auto-generated test script</span>
<span class="comment"># Suite: Smoke_Test_A | Test: TC001</span>
<span class="keyword">from</span> playwright.async_api <span class="keyword">import</span> async_playwright

<span class="keyword">async def</span> test_tc001():
    <span class="keyword">async with</span> async_playwright() <span class="keyword">as</span> p:
        browser = <span class="func">await</span> p.chromium.launch()
        page = <span class="func">await</span> browser.new_page()
        <span class="comment"># Login via SecretsManager injection</span>
        <span class="func">await</span> page.goto(<span class="string">"https://saucedemo.com"</span>)
        <span class="func">await</span> page.click(<span class="string">"#add-to-cart"</span>)
        <span class="func">print</span>(<span class="string">"PASS"</span>)  <span class="comment"># Exit code 0</span>`,
                style: "normal"
            }
        ];

        const executionSteps = [
            {
                // STEP 1
                nodes: ['node-user', 'node-server'],
                lines: ['p-user-server'],
                headline: "User Clicks 'Run Test'",
                desc: "User selects a generated test case (TC001) and triggers execution.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Endpoint:</span><code class="text-blue-300">POST /api/execute</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/core/server.py:250-285</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-purple-300">HTTP/1.1</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Content-Type:</span><code class="text-yellow-300">application/json</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Payload:</span><code class="text-cyan-300">Suite name + Test case ID</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Response Code:</span><code class="text-green-400">200 OK (async)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Latency:</span><code class="text-amber-300">~30ms (validation only)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Execution Mode:</span><code class="text-pink-300">Background (async)</code></div>
                    </div>
                `,
                path: "http_request.json",
                code: `<span class="comment">// Execute Test Request</span>
{
  <span class="key">"suite_name"</span>: <span class="string">"Smoke Test A"</span>,
  <span class="key">"test_case_id"</span>: <span class="string">"TC001"</span>,
  <span class="key">"options"</span>: {
    <span class="key">"headless"</span>: <span class="keyword">false</span>,  <span class="comment">// Visual mode</span>
    <span class="key">"timeout"</span>: <span class="number">60000</span>    <span class="comment">// 60s max</span>
  }
}`,
                style: "exec"
            },
            {
                // STEP 2
                nodes: ['node-server', 'node-fs'],
                lines: ['p-server-fs'],
                headline: "Locate Script",
                desc: "Server searches FileSystem for the generated Python script matching the ID.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/agents/test_executor.py:15-35</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Function:</span><code class="text-purple-300">locate_test_script()</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-yellow-300">File I/O (os.path.exists)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Path Pattern:</span><code class="text-cyan-300">data/generated_tests/{suite}_{id}.py</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Validation:</span><code class="text-green-400">File existence + syntax check</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Lookup Time:</span><code class="text-amber-300">~1-2ms (filesystem cache)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Error Handling:</span><code class="text-red-300">404 if not found</code></div>
                    </div>
                `,
                path: "server.py",
                code: `<span class="comment">// Location: src/agents/test_executor.py:15-35</span>
script_path = <span class="string">f"data/generated_tests/{suite}_{id}.py"</span>
<span class="keyword">if not</span> os.path.exists(script_path):
    <span class="keyword">raise</span> FileNotFoundError(
        <span class="string">f"Test script not found: {id}"</span>
    )  <span class="comment">// Returns 404 to frontend</span>
<span class="comment">// Validate Python syntax</span>
<span class="keyword">with</span> open(script_path) <span class="keyword">as</span> f:
    compile(f.read(), script_path, <span class="string">'exec'</span>)  <span class="comment">// ~1ms</span>`,
                style: "exec"
            },
            {
                // STEP 3
                nodes: ['node-server', 'node-subprocess'],
                lines: ['p-server-subprocess'],
                headline: "Spawn Subprocess",
                desc: "Server spawns an isolated Python subprocess to run the Playwright script.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/agents/test_executor.py:40-70</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Method:</span><code class="text-purple-300">subprocess.run()</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Isolation:</span><code class="text-yellow-300">Separate Python process</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Timeout:</span><code class="text-red-300">60s (configurable)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Output Capture:</span><code class="text-cyan-300">stdout + stderr</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Spawn Time:</span><code class="text-amber-300">~50-100ms (Python startup)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Benefits:</span><code class="text-green-400">Crash isolation + clean state</code></div>
                    </div>
                `,
                path: "src/agents/test_executor.py",
                code: `<span class="comment">// Location: src/agents/test_executor.py:40-70</span>
process = subprocess.run(
    [<span class="string">"python"</span>, script_path],  <span class="comment">// Isolated interpreter</span>
    capture_output=<span class="keyword">True</span>,      <span class="comment">// Capture stdout/stderr</span>
    text=<span class="keyword">True</span>,                     <span class="comment">// Decode as UTF-8</span>
    timeout=<span class="number">60</span>,                     <span class="comment">// 60s max execution</span>
    cwd=<span class="string">"./"</span>,                        <span class="comment">// Working directory</span>
    env={**os.environ}             <span class="comment">// Pass env vars</span>
)
<span class="comment">// Process isolation prevents main server crash</span>`,
                style: "exec"
            },
            {
                // STEP 4
                nodes: ['node-subprocess', 'node-browser'],
                lines: ['p-subprocess-browser'],
                headline: "Execute Script",
                desc: "Subprocess drives the browser directly. High speed, deterministic execution.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Execution Engine:</span><code class="text-green-300">Playwright Python (sync)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Browser Launch:</span><code class="text-purple-300">Chromium headless/headed</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-blue-300">CDP (Chrome DevTools)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Actions:</span><code class="text-yellow-300">click, fill, navigate, wait</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Speed:</span><code class="text-green-400">~10s vs 30s AI (3x faster)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Deterministic:</span><code class="text-cyan-300">100% reproducible</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Screenshots:</span><code class="text-amber-300">On failure (auto-capture)</code></div>
                    </div>
                `,
                path: "execution.log",
                code: `<span class="comment">// Test Execution Trace</span>
<span class="string">[00:00.000]</span> <span class="key">Launch</span>: Chromium browser started
<span class="string">[00:00.800]</span> <span class="key">Navigate</span>: https://saucedemo.com
<span class="string">[00:02.100]</span> <span class="key">Fill</span>: #user-name → standard_user
<span class="string">[00:02.300]</span> <span class="key">Fill</span>: #password → [REDACTED]
<span class="string">[00:02.500]</span> <span class="key">Click</span>: #login-button
<span class="string">[00:04.200]</span> <span class="key">Click</span>: #add-to-cart
<span class="string">[00:05.100]</span> <span class="key">Verify</span>: Cart badge shows "1" ✓
<span class="string">[00:05.300]</span> <span class="func">RESULT</span>: <span class="keyword">PASS</span> (Exit code 0)`,
                style: "exec"
            },
            {
                // STEP 5
                nodes: ['node-subprocess', 'node-server'],
                lines: ['p-subprocess-server'],
                headline: "Return Result",
                desc: "Subprocess exits. Server parses stdout/stderr for 'PASS' or 'FAIL'.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/agents/test_executor.py:75-110</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Exit Codes:</span><code class="text-purple-300">0=PASS, 1=FAIL, >1=ERROR</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Stdout Parsing:</span><code class="text-yellow-300">Regex: (PASS|FAIL)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Stderr Capture:</span><code class="text-red-300">Error messages/stack traces</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Timeout Handling:</span><code class="text-orange-300">TimeoutExpired → FAIL</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Parse Time:</span><code class="text-amber-300">~5ms (regex + validation)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Result Storage:</span><code class="text-cyan-300">In-memory + JSON file</code></div>
                    </div>
                `,
                path: "server.py",
                code: `<span class="comment">// Location: src/agents/test_executor.py:75-110</span>
<span class="keyword">if</span> process.returncode == <span class="number">0</span>:   <span class="comment">// Success exit</span>
    status = <span class="string">"PASS"</span>
<span class="keyword">elif</span> <span class="string">"FAIL"</span> <span class="keyword">in</span> process.stdout:
    status = <span class="string">"FAIL"</span>             <span class="comment">// Explicit fail</span>
<span class="keyword">else</span>:
    status = <span class="string">"ERROR"</span>            <span class="comment">// Unexpected</span>

<span class="comment">// Store result with metadata</span>
result = {
    <span class="string">"status"</span>: status,
    <span class="string">"logs"</span>: process.stdout,
    <span class="string">"errors"</span>: process.stderr
}`,
                style: "exec"
            },
            {
                // STEP 6
                nodes: ['node-server', 'node-user'],
                lines: ['p-user-server'],
                headline: "Update UI",
                desc: "Server returns result to Frontend. Status badge updates to Green/Red in real-time.",
                details: `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span class="text-slate-400">Code Location:</span><code class="text-green-300">src/core/server.py:290-310</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Response Format:</span><code class="text-purple-300">JSON (status + logs)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Protocol:</span><code class="text-blue-300">HTTP/1.1</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Response Code:</span><code class="text-green-400">200 OK</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Payload Size:</span><code class="text-cyan-300">~1-5KB (logs included)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">UI Update:</span><code class="text-yellow-300">Badge color (green/red)</code></div>
                        <div class="flex justify-between"><span class="text-slate-400">Latency:</span><code class="text-amber-300">~20ms (serialization)</code></div>
                    </div>
                `,
                path: "http_response.json",
                code: `<span class="comment">// Execution Result Response</span>
{
  <span class="key">"test_id"</span>: <span class="string">"TC001"</span>,
  <span class="key">"status"</span>: <span class="string">"PASS"</span>,  <span class="comment">// PASS | FAIL | ERROR</span>
  <span class="key">"duration_ms"</span>: <span class="number">5300</span>,
  <span class="key">"logs"</span>: <span class="string">"[Full execution trace...]"</span>,
  <span class="key">"screenshot"</span>: <span class="keyword">null</span>,  <span class="comment">// Only on failure</span>
  <span class="key">"metadata"</span>: {
    <span class="key">"browser"</span>: <span class="string">"chromium"</span>,
    <span class="key">"timestamp"</span>: <span class="string">"2025-12-03T09:55:21Z"</span>
  }
}`,
                style: "exec"
            }
        ];

        // ================= FUNCTIONS =================

        function toggleCode() {
            const container = document.getElementById('code-container');
            const chevron = document.getElementById('code-chevron');
            isCodeExpanded = !isCodeExpanded;
            if (isCodeExpanded) {
                container.style.maxHeight = '400px';
                container.classList.remove('opacity-50');
                chevron.style.transform = 'rotate(0deg)';
            } else {
                container.style.maxHeight = '32px';
                container.classList.add('opacity-50');
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        function safeClassList(id, action, className) {
            const el = document.getElementById(id);
            if (el) {
                if (action === 'add') el.classList.add(className);
                if (action === 'remove') el.classList.remove(className);
            }
        }

        function switchFlow(flowType) {
            activeFlow = flowType;
            currentStep = 0;
            const btnGen = document.getElementById('btn-gen');
            const btnExec = document.getElementById('btn-exec');
            const title = document.getElementById('flow-title');
            const subNode = document.getElementById('node-subprocess');

            // Reset Styles
            btnGen.className = "px-4 py-2 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all";
            btnExec.className = "px-4 py-2 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all";

            if (flowType === 'generation') {
                btnGen.className = "px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow-lg";
                title.innerText = "FLOW 1: GENERATION";
                title.className = "text-xs font-bold text-blue-400 uppercase tracking-wider";
                if (subNode) subNode.classList.add('hidden');
            } else {
                btnExec.className = "px-4 py-2 rounded-md text-sm font-medium transition-all bg-purple-600 text-white shadow-lg";
                title.innerText = "FLOW 2: EXECUTION";
                title.className = "text-xs font-bold text-purple-400 uppercase tracking-wider";
                if (subNode) subNode.classList.remove('hidden');
            }
            updateUI();
        }

        function nextStep() {
            const stepData = activeFlow === 'generation' ? generationSteps : executionSteps;
            if (currentStep >= stepData.length) return;
            currentStep++;
            updateUI();
        }

        function reset() {
            currentStep = 0;
            updateUI();
        }

        function updateUI() {
            const stepData = activeFlow === 'generation' ? generationSteps : executionSteps;
            const max = stepData.length;

            // 1. Progress Indicators
            if (document.getElementById('progress-bar')) {
                document.getElementById('progress-bar').style.width = `${(currentStep / max) * 100}%`;
            }
            if (document.getElementById('step-indicator')) {
                document.getElementById('step-indicator').innerText = `Step ${currentStep} of ${max}`;
            }

            // 2. Reset Visual Elements
            document.querySelectorAll('.node').forEach(el => {
                el.classList.remove('active', 'secure-active', 'opt-active', 'exec-active');
            });
            document.querySelectorAll('.connector').forEach(el => {
                el.classList.remove('active', 'secure', 'opt', 'exec');
                el.style.markerEnd = "";
            });
            safeClassList('secure-badge', 'remove', 'opacity-100');
            safeClassList('secure-badge', 'add', 'opacity-0');

            // 3. Handle Step 0 (Start state)
            if (currentStep === 0) {
                document.getElementById('step-headline').innerText = activeFlow === 'generation'
                    ? "Ready to launch exploration agent..."
                    : "Ready to execute generated test...";
                document.getElementById('detail-content').innerHTML = "<p>Select Next Step to begin trace.</p>";
                document.getElementById('code-display').innerHTML = '<span class="comment">// Idle</span>';
                document.getElementById('next-btn').innerHTML = `Start <i class="fas fa-play ml-2"></i>`;
                return;
            }

            // 4. Render Active Step
            const step = stepData[currentStep - 1];

            // Update Text Panels
            document.getElementById('step-headline').innerText = step.headline;
            document.getElementById('detail-content').innerHTML = `
                <p class="font-medium text-white mb-2">${step.desc}</p>
                <div class="mt-2 pt-2 border-t border-slate-700/50 text-xs text-slate-400 font-mono">
                    ${step.details}
                </div>
            `;
            document.getElementById('file-path').innerText = step.path || 'data.json';
            document.getElementById('code-display').innerHTML = step.code;

            // Update Button
            document.getElementById('next-btn').innerHTML = currentStep === max ?
                `Finish <i class="fas fa-check ml-2"></i>` :
                `Next Step <i class="fas fa-arrow-right ml-2"></i>`;

            // Update Graph Nodes
            if (step.nodes) {
                step.nodes.forEach(nodeId => {
                    const el = document.getElementById(nodeId);
                    if (el) {
                        el.classList.add('active');
                        if (step.style === 'secure') el.classList.add('secure-active');
                        if (step.style === 'opt') el.classList.add('opt-active');
                        if (step.style === 'exec') el.classList.add('exec-active');
                    }
                });
            }

            // Update Graph Lines
            if (step.lines) {
                step.lines.forEach(lineId => {
                    const el = document.getElementById(lineId);
                    if (el) {
                        el.classList.add('active');
                        if (step.style === 'secure') {
                            el.classList.add('secure');
                            el.style.markerEnd = "url(#arrow-green)";
                        } else if (step.style === 'opt') {
                            el.classList.add('opt');
                            el.style.markerEnd = "url(#arrow-amber)";
                        } else if (step.style === 'exec') {
                            el.classList.add('exec');
                            el.style.markerEnd = "url(#arrow-purple)";
                        } else {
                            el.style.markerEnd = "url(#arrow-blue)";
                        }
                    }
                });
            }

            // Show Secure Badge if needed
            if (step.style === 'secure') {
                safeClassList('secure-badge', 'add', 'opacity-100');
                safeClassList('secure-badge', 'remove', 'opacity-0');
            }
        }

        // Init
        switchFlow('generation');
    </script>
</body>

</html>